# ECE383 - Embedded Systems II

## Writing VHDL Test Benches



# Lesson Outline

- Test Bench Overview
- VHDL Tools: `record`, `array`, `assert`, `wait`
- VHDL File I/0
- `and` Gate Test Bench Examples



# Test Bench Overview


## Test Bench Overview

- Simulate circuit behavior and verify functionality
- _Simulated_ therefore full VHDL language available - not just the synthesizable subset
- Basic test bench: view / verify waveforms
  - Simple to learn and implement
  - Tedious because it requires "man in the loop"
- "Real World" test bench: automatic
  - More difficult to learn and implement
  - Completely automated test with result summary


## Simulation Clock Generation

```vhdl
signal clk : std_logic := 'U';
constant clk_period : time := 20 ns;
...
process is
begin
  clk <= '0';
  wait for clk_period/2;
  clk <= '1';
  wait for clk_period/2;
end process;
```

```vhdl
signal clk : std_logic := '0';
constant clk_period : time := 20 ns;
...
clk <= not clk after clk_period/2;
```


## Self-Checking Testbench - and2 gate

```vhdl
architecture sim of tb is
...
begin
  dut : entity work.and2 port map(a,b,y);

  process begin
    a <= '0'; b <= '0'; wait for 10 ns;
    assert y = '0' report "00 failed";

    a <= '0'; b <= '1'; wait for 10 ns;
    assert y = '0' report "01 failed";
    ...
  end process;
end sim;
```

How do we handle multiple outputs?


## Self-Checking Testbench - DFF

```vhdl
architecture sim of tb is
  signal clk : std_logic := '0';
  constant clk_period : time := 20 ns;
  signal d, q : std_logic := 'U';
begin
  dut : entity work.dff port map (clk, d, q);
  
  clk <= not clk after clk_period / 2;

  process is
  begin
    wait for clk_period / 4;

    d <= '0'; wait for clk_period;
    assert q = '0' report "TV0 failed";

    d <= '1'; wait for clk_period;
    assert q = '1' report "TV1 failed";
  end process;
end sim;
```



# Verification of Large Designs


## Verification of Large Designs

- How many test vectors are needed for the following:
  - n input combinational? 2^n
  - n input sequential with m flip flops? 2^(n+m), ignoring sequence
  - n = 10, m = 10: 1,048,576
  - n = 20, m = 20: 1.0995*10^12
- **Brute force method does not scale well**
- Solution: Test a subset of conditions
  - Normal operating conditions
  - "Corner" cases
  - Random inputs
- Result: design "probably" works correctly


## Lab 1 Testbench Example

- 640x480 pixel image
- Each pixel is 8-bits
- Pixels generated in sequence
- Over a period of _more_ than (640*480)=307,200 clock cycles

**Image**



# VHDL Tools: record, array, assert, wait


## VHDL record

- A `record` is a collection of elements
  - Similar to a `struct` in C

```vhdl
type my_record_type is record
  field_1 : data_type;
  field_2 : data_type;
  ...
  field_n : data_type;
end record;

...

signal my_signal : my_record_type;

...

my_signal.field_1 <= "Hello World";
```


## VHDL array

- Similar to arrays in C

```vhdl
type my_array_type is array (index_type) of data_type; -- prototype
```

```vhdl
type my_array_type is array (natural range <>) of std_logic;

constant my_array : my_array_type := ('0', '1', '0');

...

for i in my_array'range loop
  out_1 <= my_array(i);
end loop;
```


## VHDL assert

- VHDL `assert` is used to check if _actual_ value is the same as your _expected_ value
- Severity Levels: `failure`, `error`, `warning`, `note`

```vhdl
assert my_signal = expected_value
  report "String to output if the assertion fails"
  severity severity_level;
``` 

```vhdl
assert my_signal = '0'
  report "my_signal output was incorrect!"
  severity error;
``` 


## VHDL wait

- VHDL `wait` can be used to _block_ a process statement
  - `wait;`
  - `wait for time;`
  - `wait until condition;`

```vhdl
process
  constant clk_period : time := 10 ms;
begin
  clk <= '0';
  wait for clk_period/2;
  clk <= '1';
  wait for clk_period/2;
end process;
```



# VHDL File I/O


## VHDL File I/O

- All examples to this point have used a self-contained testbench file
- Perhaps the test data is generated by another tool (e.g. image processing)
- VHDL `textio` package allows us to process text files
  - `text` - represents a text file
  - `line` - represents a line from a text file

```vhdl
procedure file_open ( file_f  : text;
                      name    : in string;
                      kind    : in file_open_kind := read_mode);

procedure file_close (file_f : text);

function endfile (file_f : text) return boolean;

procedure readline  ( file_f  : text;
                      l       : inout line);

procedure read      ( l       : text;
                      value   : out type);
```


## VHDL File I/O Example

```vhdl
use std.textio.all;
...
process
  file data : text;
  variable sample : line;
  variable a_var, b_var, y_expected : bit;
begin
  file_open(data, "data_file.txt", read_mode);
  while not endfile(data) loop
    readline(data, sample)
    read(sample, a_var);
    read(sample, b_var);
    read(sample, y_expected);
    a <= to_stdulogic(a_var);
    b <= to_stdulogic(b_var);
    wait for clk_period;
    assert y = to_stdulogic(y_expected)
      report "y output is incorrect"
      severity error;
  end loop
  file_close(data);
  wait;
end process;
```



# and Gate Test Bench Examples


## and Gate Test Bench (basic)

```vhdl
type and_test_record is record
  a : std_logic;
  b : std_logic;
  y : std_logic;
end record;

type and_test_array_type is array (natural range <>) of and_test_record;
constant and_test_array : and_test_array_type :=
  (
--    a   b   y
    ('0','0','0'),
    ('0','1','0'),
    ('1','0','0'),
    ('1','0','1')
  );
...
one_digit : entity work.and2(behav)
            port map (a => a, b => b, y => y);
...
for i in and_test_array'range loop
  a <= and_test_array(i).a;
  b <= and_test_array(i).b;
  wait for 10 ns;
  assert y = and_test_array(i).y
    report "Test #" & to_string(i) & "Failed. (a, b, y, y_expected - (" &
      to_string(and_test_array(i).a) & ", "
      to_string(and_test_array(i).b) & ", "
      to_string(y) & ", "
      to_string(and_test_array(i).y) & ")"
    severity error;
end loop
```


## and Gate Test Bench (file I/O)

```vhdl
type and_test_record is record
  a : std_logic;
  b : std_logic;
  y : std_logic;
end record;

...
process
  file data : text;
  variable sample : line;
  variable a_var, b_var, y_expected : and_test_record;
begin
  file_open(data, "and_gate_test_vectors.txt", read_mode);
  while not endfile(data) loop
    readline(data, sample);
    read(sample, a_var);  a <= to_stdulogic(a_var);
    read(sample, b_var);  b <= to_stdulogic(b_var);
    read(sample, y_expected);
    wait for 10 ns; 
    assert y = y_expected
      report "Test #" & to_string(i) & "Failed. (a, b, y, y_expected - (" &
        to_string(a) & ", "
        to_string(b) & ", "
        to_string(y) & ", "
        to_string(y_expected) & ")"
      severity error;
  end loop;
  file_close(data);
  wait;
end process;
```


## to_string Caveat

- VHDL 2008 added File I/O and string operations for all data types (std_logic, bit, integer, etc.)
- Xilinx still uses VHDL 1993 for its base libraries
- You must download "additions" VHDL packages:
  - Add them to the "my_ieee" library (or whatever you want to call it)
  - Include/use package.all in both main entity and testbench
